<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Korea Food Finder</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #f5f5f5;
  color: #333;
  overflow-x: hidden;
}

#map {
  width: 100%;
  height: 45vh;
  min-height: 250px;
}

.controls {
  background: #fff;
  padding: 10px 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  position: sticky;
  top: 0;
  z-index: 10;
}

.filter-row {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding-bottom: 8px;
  scrollbar-width: none;
  -ms-overflow-style: none;
}
.filter-row::-webkit-scrollbar { display: none; }

.filter-btn {
  flex-shrink: 0;
  padding: 6px 14px;
  border: 1.5px solid #ddd;
  border-radius: 20px;
  background: #fff;
  font-size: 13px;
  color: #555;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
}
.filter-btn.active {
  background: #e74c3c;
  color: #fff;
  border-color: #e74c3c;
}

.group-btn {
  flex-shrink: 0;
  padding: 7px 18px;
  border: 2px solid #ddd;
  border-radius: 20px;
  background: #fff;
  font-size: 14px;
  font-weight: 600;
  color: #555;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
}
.group-btn.active {
  background: #333;
  color: #fff;
  border-color: #333;
}

.sub-row {
  display: flex;
  gap: 6px;
  overflow-x: auto;
  padding-bottom: 4px;
  scrollbar-width: none;
  -ms-overflow-style: none;
}
.sub-row::-webkit-scrollbar { display: none; }

.radius-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding-top: 6px;
}
.radius-row label {
  font-size: 12px;
  color: #888;
  white-space: nowrap;
}
.radius-row input[type=range] {
  flex: 1;
  accent-color: #e74c3c;
}
.radius-row .radius-val {
  font-size: 12px;
  font-weight: 600;
  color: #e74c3c;
  min-width: 38px;
  text-align: right;
}

#results {
  padding: 10px 12px 80px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.card {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  overflow: hidden;
  cursor: pointer;
  transition: box-shadow 0.2s;
}
.card:active { box-shadow: 0 2px 10px rgba(0,0,0,0.18); }

.card-body {
  display: flex;
  gap: 12px;
  padding: 12px;
}

.card-photo {
  width: 80px;
  height: 80px;
  border-radius: 8px;
  object-fit: cover;
  flex-shrink: 0;
  background: #eee;
}

.card-info {
  flex: 1;
  min-width: 0;
}

.card-name {
  font-size: 15px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 6px 12px;
  margin-top: 4px;
  font-size: 12px;
  color: #888;
}

.stars {
  color: #f5a623;
  letter-spacing: -1px;
}

.badge-open {
  color: #27ae60;
  font-weight: 600;
}
.badge-closed {
  color: #e74c3c;
  font-weight: 600;
}

.card-distance {
  display: inline-block;
  font-size: 12px;
  font-weight: 700;
  color: #4285f4;
  margin-top: 5px;
  background: #e8f0fe;
  padding: 2px 8px;
  border-radius: 10px;
}

.price {
  color: #27ae60;
  font-weight: 600;
}

/* Detail overlay */
.overlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 100;
  background: rgba(0,0,0,0.45);
}
.overlay.open { display: flex; }

.detail-sheet {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  max-height: 85vh;
  background: #fff;
  border-radius: 16px 16px 0 0;
  overflow-y: auto;
  padding: 20px 16px 30px;
  animation: slideUp 0.25s ease-out;
}
@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.detail-sheet .handle {
  width: 36px;
  height: 4px;
  background: #ddd;
  border-radius: 2px;
  margin: 0 auto 14px;
}

.detail-name {
  font-size: 20px;
  font-weight: 700;
}
.detail-addr {
  font-size: 13px;
  color: #888;
  margin-top: 4px;
}
.detail-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 8px 16px;
  margin-top: 10px;
  font-size: 13px;
  color: #666;
}

.detail-photos {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  margin-top: 14px;
  scrollbar-width: none;
}
.detail-photos::-webkit-scrollbar { display: none; }
.detail-photos img {
  height: 140px;
  border-radius: 10px;
  object-fit: cover;
  flex-shrink: 0;
}

.detail-actions {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}
.detail-actions a {
  flex: 1;
  text-align: center;
  padding: 12px;
  border-radius: 10px;
  text-decoration: none;
  font-weight: 600;
  font-size: 14px;
}
.btn-directions {
  background: #4285f4;
  color: #fff;
}
.btn-call {
  background: #27ae60;
  color: #fff;
}

.detail-reviews {
  margin-top: 18px;
}
.detail-reviews h3 {
  font-size: 15px;
  margin-bottom: 10px;
}
.review {
  padding: 10px 0;
  border-top: 1px solid #eee;
}
.review-author {
  font-size: 13px;
  font-weight: 600;
}
.review-text {
  font-size: 13px;
  color: #555;
  margin-top: 4px;
  line-height: 1.5;
}

.loading-msg {
  text-align: center;
  padding: 40px 20px;
  color: #aaa;
  font-size: 14px;
}

.error-msg {
  text-align: center;
  padding: 30px 20px;
  color: #e74c3c;
  font-size: 14px;
}

/* Rating filter */
.rating-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding-top: 6px;
}
.rating-row label {
  font-size: 12px;
  color: #888;
  white-space: nowrap;
}
.rating-btn {
  padding: 4px 12px;
  border: 1.5px solid #ddd;
  border-radius: 14px;
  background: #fff;
  font-size: 12px;
  color: #555;
  cursor: pointer;
  transition: all 0.2s;
}
.rating-btn.active {
  background: #f5a623;
  color: #fff;
  border-color: #f5a623;
}

/* Style filter */
.style-row {
  display: flex;
  align-items: center;
  gap: 6px;
  padding-top: 6px;
  overflow-x: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
}
.style-row::-webkit-scrollbar { display: none; }
.style-row label {
  font-size: 12px;
  color: #888;
  white-space: nowrap;
  flex-shrink: 0;
}
.style-btn {
  flex-shrink: 0;
  padding: 4px 12px;
  border: 1.5px solid #ddd;
  border-radius: 14px;
  background: #fff;
  font-size: 12px;
  color: #555;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
}
.style-btn.active {
  background: #8e44ad;
  color: #fff;
  border-color: #8e44ad;
}

/* AI Pick styles */
.card.ai-pick {
  border-left: 4px solid #f5a623;
}

.ai-badge {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  background: linear-gradient(135deg, #f5a623, #e6950e);
  color: #fff;
  font-size: 11px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 10px;
  margin-bottom: 4px;
}

.ai-reason {
  font-size: 11px;
  color: #b07d10;
  margin-top: 2px;
  line-height: 1.4;
}

/* Toggle filters */
.toggle-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding-top: 6px;
  overflow-x: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
}
.toggle-row::-webkit-scrollbar { display: none; }
.toggle-row label {
  font-size: 12px;
  color: #888;
  white-space: nowrap;
  flex-shrink: 0;
}
.toggle-btn {
  flex-shrink: 0;
  padding: 4px 12px;
  border: 1.5px solid #ddd;
  border-radius: 14px;
  background: #fff;
  font-size: 12px;
  color: #555;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
}
.toggle-btn.active {
  background: #27ae60;
  color: #fff;
  border-color: #27ae60;
}

/* Price filter */
.price-btn {
  flex-shrink: 0;
  padding: 4px 10px;
  border: 1.5px solid #ddd;
  border-radius: 14px;
  background: #fff;
  font-size: 11px;
  color: #555;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
}
.price-btn.active {
  background: #27ae60;
  color: #fff;
  border-color: #27ae60;
}

/* Surprise Me */
.surprise-btn {
  display: block;
  width: 100%;
  margin-top: 8px;
  padding: 10px;
  border: 2px dashed #f5a623;
  border-radius: 12px;
  background: #fffbf0;
  color: #b07d10;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.surprise-btn:active {
  background: #f5a623;
  color: #fff;
}

/* Cheat sheet */
.cheatsheet-toggle {
  display: block;
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  border: 1.5px solid #ddd;
  border-radius: 12px;
  background: #fff;
  color: #555;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  text-align: center;
}
.cheatsheet-panel {
  display: none;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  padding: 14px;
  margin-top: 8px;
}
.cheatsheet-panel.open { display: block; }
.cheatsheet-panel h4 {
  font-size: 14px;
  margin-bottom: 8px;
  color: #333;
}
.cheatsheet-panel table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.cheatsheet-panel td {
  padding: 5px 8px;
  border-bottom: 1px solid #f0f0f0;
}
.cheatsheet-panel td:first-child {
  font-weight: 600;
  color: #333;
  width: 45%;
}
.cheatsheet-panel td:last-child {
  color: #888;
}
.cheatsheet-section { margin-top: 12px; }
.cheatsheet-section:first-child { margin-top: 0; }

/* Naver directions button */
.btn-naver {
  background: #03c75a;
  color: #fff;
}

/* Search bar */
.search-row {
  display: flex;
  gap: 8px;
  padding-top: 8px;
}
.search-row input {
  flex: 1;
  padding: 8px 14px;
  border: 1.5px solid #ddd;
  border-radius: 20px;
  font-size: 13px;
  outline: none;
}
.search-row input:focus { border-color: #e74c3c; }
.search-row button {
  padding: 8px 16px;
  border: none;
  border-radius: 20px;
  background: #e74c3c;
  color: #fff;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  flex-shrink: 0;
}
</style>
</head>
<body>

<div id="map"></div>

<div class="controls">
  <div class="filter-row" id="groupFilters"></div>
  <div class="sub-row" id="subFilters"></div>
  <div class="radius-row">
    <label>Search radius:</label>
    <input type="range" id="radiusSlider" min="500" max="3000" step="250" value="1000">
    <span class="radius-val" id="radiusVal">1 km</span>
  </div>
  <div class="rating-row">
    <label>Min rating:</label>
    <button class="rating-btn active" data-rating="0">Any</button>
    <button class="rating-btn" data-rating="3.5">3.5+</button>
    <button class="rating-btn" data-rating="4.0">4.0+</button>
    <button class="rating-btn" data-rating="4.5">4.5+</button>
  </div>
  <div class="style-row">
    <label>Style:</label>
    <button class="style-btn active" data-style="">Any</button>
    <button class="style-btn" data-style="Í∞ÄÏ†ïÏãù Î°úÏª¨ ÎßõÏßë">Family Owned</button>
    <button class="style-btn" data-style="ÌîÑÎûúÏ∞®Ïù¥Ï¶à Ï≤¥Ïù∏ Ìå®Ïä§Ìä∏Ìë∏Îìú">Fast Food/Chain</button>
    <button class="style-btn" data-style="ÌååÏù∏Îã§Ïù¥Îãù Í≥†Í∏â Î†àÏä§ÌÜ†Îûë">Fine Dining</button>
    <button class="style-btn" data-style="Ìè¨Ïû•ÎßàÏ∞® ÎÖ∏Ï†ê Í∏∏Í±∞Î¶¨ÏùåÏãù">Street Food</button>
  </div>
  <div class="toggle-row">
    <label>Price:</label>
    <button class="price-btn active" data-price="-1">Any</button>
    <button class="price-btn" data-price="1">‚Ç© &lt;10k</button>
    <button class="price-btn" data-price="2">‚Ç©‚Ç© 10-25k</button>
    <button class="price-btn" data-price="3">‚Ç©‚Ç©‚Ç© 25-50k</button>
    <button class="price-btn" data-price="4">‚Ç©‚Ç©‚Ç©‚Ç© 50k+</button>
  </div>
  <div class="toggle-row">
    <button class="toggle-btn" id="openNowBtn">Open Now</button>
    <button class="toggle-btn" id="englishBtn">English-Friendly</button>
  </div>
  <div class="search-row">
    <input type="text" id="searchInput" placeholder="Search anything... e.g. &quot;rooftop bar&quot;">
    <button id="searchBtn">Search</button>
  </div>
</div>

<div id="results">
  <div class="loading-msg" id="statusMsg">Detecting your location...</div>
</div>

<div style="padding: 0 12px 20px;">
  <button class="surprise-btn" id="surpriseBtn">üé≤ Surprise Me!</button>
  <button class="cheatsheet-toggle" id="cheatsheetToggle">üìñ Korean Menu Cheat Sheet</button>
  <div class="cheatsheet-panel" id="cheatsheetPanel">
    <div class="cheatsheet-section">
      <h4>Meat & BBQ</h4>
      <table>
        <tr><td>ÏÇºÍ≤πÏÇ¥ (samgyeopsal)</td><td>Pork belly</td></tr>
        <tr><td>Í∞àÎπÑ (galbi)</td><td>Marinated short ribs</td></tr>
        <tr><td>Î∂àÍ≥†Í∏∞ (bulgogi)</td><td>Marinated beef slices</td></tr>
        <tr><td>Î™©ÏÇ¥ (moksal)</td><td>Pork neck</td></tr>
        <tr><td>ÏπòÌÇ® (chikin)</td><td>Fried chicken</td></tr>
        <tr><td>ÏñëÎÖêÏπòÌÇ® (yangnyeom)</td><td>Sweet & spicy chicken</td></tr>
      </table>
    </div>
    <div class="cheatsheet-section">
      <h4>Rice & Noodles</h4>
      <table>
        <tr><td>ÎπÑÎπîÎ∞• (bibimbap)</td><td>Mixed rice bowl</td></tr>
        <tr><td>ÍπÄÎ∞• (gimbap)</td><td>Seaweed rice roll</td></tr>
        <tr><td>Î≥∂ÏùåÎ∞• (bokkeumbap)</td><td>Fried rice</td></tr>
        <tr><td>ÎÉâÎ©¥ (naengmyeon)</td><td>Cold noodles</td></tr>
        <tr><td>ÏûîÏπòÍµ≠Ïàò (janchi-guksu)</td><td>Banquet noodles</td></tr>
        <tr><td>ÎùºÎ©¥ (ramyeon)</td><td>Ramen / instant noodles</td></tr>
      </table>
    </div>
    <div class="cheatsheet-section">
      <h4>Soups & Stews</h4>
      <table>
        <tr><td>ÍπÄÏπòÏ∞åÍ∞ú (kimchi-jjigae)</td><td>Kimchi stew</td></tr>
        <tr><td>ÎêúÏû•Ï∞åÍ∞ú (doenjang-jjigae)</td><td>Soybean paste stew</td></tr>
        <tr><td>ÏàúÎëêÎ∂ÄÏ∞åÍ∞ú (sundubu)</td><td>Soft tofu stew</td></tr>
        <tr><td>ÏÇºÍ≥ÑÌÉï (samgyetang)</td><td>Ginseng chicken soup</td></tr>
        <tr><td>Íµ≠Î∞• (gukbap)</td><td>Rice soup</td></tr>
        <tr><td>ÏÑ§Î†ÅÌÉï (seolleongtang)</td><td>Ox bone soup</td></tr>
      </table>
    </div>
    <div class="cheatsheet-section">
      <h4>Street Food & Snacks</h4>
      <table>
        <tr><td>Îñ°Î≥∂Ïù¥ (tteokbokki)</td><td>Spicy rice cakes</td></tr>
        <tr><td>ÎßåÎëê (mandu)</td><td>Dumplings</td></tr>
        <tr><td>Ìò∏Îñ° (hotteok)</td><td>Sweet pancake</td></tr>
        <tr><td>ÏàúÎåÄ (sundae)</td><td>Blood sausage</td></tr>
        <tr><td>Ïñ¥Î¨µ (eomuk)</td><td>Fish cake skewer</td></tr>
        <tr><td>Î∂ïÏñ¥Îπµ (bungeoppang)</td><td>Fish-shaped pastry</td></tr>
      </table>
    </div>
    <div class="cheatsheet-section">
      <h4>Useful Phrases</h4>
      <table>
        <tr><td>Î©îÎâ¥Ìåê Ï£ºÏÑ∏Ïöî</td><td>Menu please</td></tr>
        <tr><td>ÏòÅÏñ¥ Î©îÎâ¥ ÏûàÏñ¥Ïöî?</td><td>English menu?</td></tr>
        <tr><td>Ïù¥Í±∞ Ï£ºÏÑ∏Ïöî</td><td>This one please</td></tr>
        <tr><td>Îß§Ïö¥Í∞ÄÏöî?</td><td>Is it spicy?</td></tr>
        <tr><td>Ïïà ÎßµÍ≤å Ìï¥Ï£ºÏÑ∏Ïöî</td><td>Not spicy please</td></tr>
        <tr><td>Í≥ÑÏÇ∞Ïù¥Ïöî</td><td>Bill/check please</td></tr>
        <tr><td>ÎßõÏûàÏñ¥Ïöî!</td><td>It's delicious!</td></tr>
        <tr><td>ÌôîÏû•Ïã§ Ïñ¥ÎîîÏòàÏöî?</td><td>Where's the restroom?</td></tr>
      </table>
    </div>
  </div>
</div>

<!-- Detail overlay -->
<div class="overlay" id="overlay">
  <div class="detail-sheet" id="detailSheet">
    <div class="handle"></div>
    <div id="detailContent"></div>
  </div>
</div>

<script>
const API_KEY = 'AIzaSyBTKSXtUuRGiTEaBPITI8CrO4JRlAcuz7Q';


const CATEGORY_GROUPS = [
  {
    label: 'Restaurant', type: 'restaurant',
    subs: [
      { label: 'All',         keyword: '' },
      { label: 'Bibimbap',    keyword: 'ÎπÑÎπîÎ∞•' },
      { label: 'Breakfast',   keyword: 'ÏïÑÏπ®ÏãùÏÇ¨ brunch' },
      { label: 'Chicken',     keyword: 'ÏπòÌÇ®' },
      { label: 'Chinese',     keyword: 'Ï§ëÍµ≠Ïßë ÏßúÏû•Î©¥' },
      { label: 'Dumplings',   keyword: 'ÎßåÎëê' },
      { label: 'Japanese',    keyword: 'ÏùºÏãù Ï¥àÎ∞• ÎùºÎ©ò' },
      { label: 'Kimbap',      keyword: 'ÍπÄÎ∞•' },
      { label: 'Korean BBQ',  keyword: 'ÏÇºÍ≤πÏÇ¥ Í≥†Í∏∞Íµ¨Ïù¥' },
      { label: 'Noodles',     keyword: 'Íµ≠Ïàò Î©¥' },
      { label: 'Porridge',    keyword: 'Ï£Ω' },
      { label: 'Seafood',     keyword: 'Ìï¥ÏÇ∞Î¨º ÌöüÏßë' },
      { label: 'Soup/Stew',   keyword: 'Ï∞åÍ∞ú Íµ≠Î∞• ÌÉï' },
      { label: 'Street Food', keyword: 'Î∂ÑÏãù Îñ°Î≥∂Ïù¥' },
      { label: 'Tteokbokki',  keyword: 'Îñ°Î≥∂Ïù¥' },
    ]
  },
  {
    label: 'Cafe', type: 'cafe',
    subs: [
      { label: 'All',             keyword: '' },
      { label: 'Bubble Tea',      keyword: 'Î≤ÑÎ∏îÌã∞ Í≥µÏ∞®' },
      { label: 'Coffee',          keyword: 'Ïª§Ìîº Ïπ¥Ìéò' },
      { label: 'Matcha',          keyword: 'ÎßêÏ∞® ÎÖπÏ∞® Ïπ¥Ìéò' },
      { label: 'Traditional Tea', keyword: 'Ï†ÑÌÜµÏ∞® Ï∞ªÏßë' },
    ]
  },
  {
    label: 'Bar', type: 'bar',
    subs: [
      { label: 'All',        keyword: '' },
      { label: 'Casual',     keyword: 'Ìò∏ÌîÑ Ìè¨Ï∞®' },
      { label: 'Cocktails',  keyword: 'ÏπµÌÖåÏùº Î∞î' },
      { label: 'Craft Beer', keyword: 'ÏàòÏ†úÎß•Ï£º ÌÅ¨ÎûòÌîÑÌä∏ÎπÑÏñ¥' },
      { label: 'Whiskey',    keyword: 'ÏúÑÏä§ÌÇ§ Î∞î' },
      { label: 'Wine',       keyword: 'ÏôÄÏù∏ Î∞î' },
    ]
  },
];

let map, userMarker, infoWindow, placesService;
let userLat, userLng;
let activeGroup = 0;
let activeSub = 0;
let searchRadius = 1000;
let markers = [];
let lastResults = [];
let minRating = 0;
let styleKeyword = '';
let openNowOnly = false;
let maxPrice = -1;
let englishFriendly = false;

// ---- Build group + subcategory buttons ----
const groupFiltersEl = document.getElementById('groupFilters');
const subFiltersEl = document.getElementById('subFilters');

function buildSubButtons() {
  subFiltersEl.innerHTML = '';
  const group = CATEGORY_GROUPS[activeGroup];
  group.subs.forEach((sub, i) => {
    const btn = document.createElement('button');
    btn.className = 'filter-btn' + (i === activeSub ? ' active' : '');
    btn.textContent = sub.label;
    btn.addEventListener('click', () => {
      subFiltersEl.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      activeSub = i;
      searchNearby();
    });
    subFiltersEl.appendChild(btn);
  });
}

CATEGORY_GROUPS.forEach((group, i) => {
  const btn = document.createElement('button');
  btn.className = 'group-btn' + (i === 0 ? ' active' : '');
  btn.textContent = group.label;
  btn.addEventListener('click', () => {
    groupFiltersEl.querySelectorAll('.group-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeGroup = i;
    activeSub = 0;
    buildSubButtons();
    searchNearby();
  });
  groupFiltersEl.appendChild(btn);
});

buildSubButtons();

// ---- Radius slider ----
const radiusSlider = document.getElementById('radiusSlider');
const radiusVal = document.getElementById('radiusVal');
radiusSlider.addEventListener('input', () => {
  searchRadius = parseInt(radiusSlider.value);
  radiusVal.textContent = searchRadius >= 1000
    ? (searchRadius / 1000).toFixed(searchRadius % 1000 === 0 ? 0 : 1) + ' km'
    : searchRadius + 'm';
});
radiusSlider.addEventListener('change', () => {
  searchRadius = parseInt(radiusSlider.value);
  searchNearby();
});

// ---- Rating filter buttons ----
document.querySelectorAll('.rating-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    minRating = parseFloat(btn.dataset.rating);
    searchNearby();
  });
});

// ---- Style filter buttons ----
document.querySelectorAll('.style-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    styleKeyword = btn.dataset.style;
    searchNearby();
  });
});

// ---- Price filter buttons ----
document.querySelectorAll('.price-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.price-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    maxPrice = parseInt(btn.dataset.price);
    searchNearby();
  });
});

// ---- Open Now toggle ----
const openNowBtn = document.getElementById('openNowBtn');
openNowBtn.addEventListener('click', () => {
  openNowOnly = !openNowOnly;
  openNowBtn.classList.toggle('active', openNowOnly);
  searchNearby();
});

// ---- English-friendly toggle ----
const englishBtn = document.getElementById('englishBtn');
englishBtn.addEventListener('click', () => {
  englishFriendly = !englishFriendly;
  englishBtn.classList.toggle('active', englishFriendly);
  searchNearby();
});

// ---- Surprise Me ----
document.getElementById('surpriseBtn').addEventListener('click', () => {
  if (!lastResults.length) return;
  const pick = lastResults[Math.floor(Math.random() * Math.min(lastResults.length, 10))];
  showDetail(pick);
});

// ---- Cheat Sheet toggle ----
document.getElementById('cheatsheetToggle').addEventListener('click', () => {
  document.getElementById('cheatsheetPanel').classList.toggle('open');
});

// ---- Custom search bar ----
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');

function doCustomSearch() {
  const query = searchInput.value.trim();
  if (!query || !userLat || !placesService) return;

  clearMarkers();
  document.getElementById('results').innerHTML = '<div class="loading-msg" id="statusMsg">Searching...</div>';

  // Deactivate category buttons to show custom search is active
  subFiltersEl.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));

  const customReq = {
    location: new google.maps.LatLng(userLat, userLng),
    radius: searchRadius,
    keyword: query,
  };
  if (openNowOnly) customReq.openNow = true;

  placesService.nearbySearch(customReq, (results, status) => {
    if (status !== google.maps.places.PlacesServiceStatus.OK || !results.length) {
      document.getElementById('results').innerHTML = '';
      setStatus('No results for "' + query + '". Try different words or a larger radius.', true);
      return;
    }

    if (minRating > 0) {
      results = results.filter(p => p.rating && p.rating >= minRating);
    }
    if (maxPrice > 0) {
      results = results.filter(p => p.price_level != null && p.price_level <= maxPrice);
    }
    if (!results.length) {
      document.getElementById('results').innerHTML = '';
      setStatus('No places match the current filters.', true);
      return;
    }

    results.forEach(place => {
      const dist = getDistance(userLat, userLng, place.geometry.location.lat(), place.geometry.location.lng());
      place._aiScore = computeAIScore(place, dist);
      place._dist = dist;
    });
    results.sort((a, b) => b._aiScore - a._aiScore);
    results.forEach((place, i) => { place._isAIPick = i < 3; });

    lastResults = results;
    renderResults(results);
    addMarkers(results);
  });
}

searchBtn.addEventListener('click', doCustomSearch);
searchInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') { e.preventDefault(); doCustomSearch(); }
});

// ---- Overlay close ----
document.getElementById('overlay').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeDetail();
});

function closeDetail() {
  document.getElementById('overlay').classList.remove('open');
}

// ---- Helpers ----
function getDistance(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function formatDistance(m) {
  return m >= 1000 ? (m/1000).toFixed(1) + ' km' : Math.round(m) + 'm';
}

function starsHtml(rating) {
  if (!rating) return '';
  const full = Math.floor(rating);
  const half = rating - full >= 0.3;
  let s = '';
  for (let i = 0; i < full; i++) s += '‚òÖ';
  if (half) s += '¬Ω';
  return `<span class="stars">${s}</span> ${rating.toFixed(1)}`;
}

function priceHtml(level) {
  if (level == null) return '';
  return '<span class="price">' + '‚Ç©'.repeat(level) + '</span>';
}

function clearMarkers() {
  markers.forEach(m => m.setMap(null));
  markers = [];
}

// ---- Status message ----
function setStatus(msg, isError) {
  const el = document.getElementById('statusMsg');
  if (!el) {
    const r = document.getElementById('results');
    const d = document.createElement('div');
    d.className = isError ? 'error-msg' : 'loading-msg';
    d.id = 'statusMsg';
    d.textContent = msg;
    r.prepend(d);
  } else {
    el.className = isError ? 'error-msg' : 'loading-msg';
    el.textContent = msg;
    el.style.display = '';
  }
}

// ---- AI Scoring ----
function computeAIScore(place, distance) {
  // Rating component (40%) ‚Äî normalized 0-100 from 1-5 scale
  const rating = place.rating || 0;
  const ratingScore = Math.max(0, (rating - 1) / 4) * 100;

  // Popularity component (25%) ‚Äî log-scaled review count
  const reviews = place.user_ratings_total || 0;
  const popularityScore = Math.min(100, Math.log10(reviews + 1) / Math.log10(2000) * 100);

  // Proximity component (20%) ‚Äî closer is better, within searchRadius
  const proximityScore = Math.max(0, (1 - distance / searchRadius)) * 100;

  // Availability component (15%) ‚Äî bonus if currently open
  const isOpen = place.opening_hours ? place.opening_hours.isOpen() : null;
  const availabilityScore = isOpen === true ? 100 : (isOpen === false ? 0 : 50);

  return ratingScore * 0.4 + popularityScore * 0.25 + proximityScore * 0.2 + availabilityScore * 0.15;
}

function generateReason(place, distance, isOpen) {
  const parts = [];
  if (place.rating >= 4.5) parts.push('Exceptional rating');
  else if (place.rating >= 4.0) parts.push('Highly rated');
  else if (place.rating >= 3.5) parts.push('Well rated');

  const reviews = place.user_ratings_total || 0;
  if (reviews >= 1000) parts.push(`with ${Math.round(reviews / 100) * 100}+ reviews`);
  else if (reviews >= 100) parts.push(`with ${Math.round(reviews / 10) * 10}+ reviews`);

  const distM = Math.round(distance);
  if (distM <= 200) parts.push('just steps away');
  else if (distM <= 500) parts.push(`only ${distM}m away`);

  if (isOpen === true) parts.push('open now');

  return parts.length > 0 ? parts.join(', ') : 'Top pick nearby';
}

// ---- Search ----
function searchNearby() {
  if (!userLat || !placesService) return;

  clearMarkers();
  document.getElementById('results').innerHTML = '<div class="loading-msg" id="statusMsg">Searching nearby restaurants...</div>';

  const group = CATEGORY_GROUPS[activeGroup];
  const sub = group.subs[activeSub];
  const request = {
    location: new google.maps.LatLng(userLat, userLng),
    radius: searchRadius,
    type: group.type,
  };
  const keywordParts = [sub.keyword, styleKeyword];
  if (englishFriendly) keywordParts.push('ÏòÅÏñ¥ Î©îÎâ¥ English menu');
  const keywords = keywordParts.filter(Boolean).join(' ');
  if (keywords) {
    request.keyword = keywords;
  }
  if (openNowOnly) {
    request.openNow = true;
  }

  placesService.nearbySearch(request, (results, status) => {
    if (status !== google.maps.places.PlacesServiceStatus.OK || !results.length) {
      document.getElementById('results').innerHTML = '';
      setStatus(status === 'ZERO_RESULTS' ? 'No places found. Try a larger radius or different category.' : 'Search failed: ' + status, true);
      return;
    }

    // Apply minimum rating filter
    if (minRating > 0) {
      results = results.filter(p => p.rating && p.rating >= minRating);
    }

    // Apply price level filter
    if (maxPrice > 0) {
      results = results.filter(p => p.price_level != null && p.price_level <= maxPrice);
    }

    if (!results.length) {
      document.getElementById('results').innerHTML = '';
      setStatus('No places match the current filters. Try adjusting your criteria.', true);
      return;
    }

    // Compute AI scores and attach to each result
    results.forEach(place => {
      const dist = getDistance(userLat, userLng, place.geometry.location.lat(), place.geometry.location.lng());
      place._aiScore = computeAIScore(place, dist);
      place._dist = dist;
    });

    // Sort by AI score descending
    results.sort((a, b) => b._aiScore - a._aiScore);

    // Tag top 3 as AI Picks
    results.forEach((place, i) => {
      place._isAIPick = i < 3;
    });

    lastResults = results;
    renderResults(results);
    addMarkers(results);
  });
}

function renderResults(places) {
  const container = document.getElementById('results');
  container.innerHTML = '';

  places.forEach((place, idx) => {
    const dist = place._dist != null ? place._dist : getDistance(userLat, userLng, place.geometry.location.lat(), place.geometry.location.lng());
    const photoUrl = place.photos && place.photos.length
      ? place.photos[0].getUrl({ maxWidth: 200, maxHeight: 200 })
      : '';

    const isOpen = place.opening_hours ? place.opening_hours.isOpen() : null;
    let openBadge = '';
    if (isOpen === true) openBadge = '<span class="badge-open">Open</span>';
    else if (isOpen === false) openBadge = '<span class="badge-closed">Closed</span>';

    let aiBadgeHtml = '';
    if (place._isAIPick) {
      const reason = generateReason(place, dist, isOpen);
      aiBadgeHtml = `<div class="ai-badge">‚ú¶ AI Pick</div><div class="ai-reason">${reason}</div>`;
    }

    const card = document.createElement('div');
    card.className = 'card' + (place._isAIPick ? ' ai-pick' : '');
    card.innerHTML = `
      <div class="card-body">
        ${photoUrl ? `<img class="card-photo" src="${photoUrl}" alt="" loading="lazy">` : '<div class="card-photo"></div>'}
        <div class="card-info">
          ${aiBadgeHtml}
          <div class="card-name">${place.name}</div>
          <div class="card-meta">
            ${starsHtml(place.rating)}
            ${place.user_ratings_total ? '<span>(' + place.user_ratings_total + ')</span>' : ''}
            ${priceHtml(place.price_level)}
            ${openBadge}
          </div>
          <div class="card-distance">${formatDistance(dist)}</div>
        </div>
      </div>`;
    card.addEventListener('click', () => showDetail(place));
    container.appendChild(card);
  });
}

function addMarkers(places) {
  places.forEach((place, idx) => {
    const iconUrl = place._isAIPick
      ? 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png'
      : 'https://maps.google.com/mapfiles/ms/icons/red-dot.png';
    const marker = new google.maps.Marker({
      position: place.geometry.location,
      map: map,
      title: place.name,
      icon: { url: iconUrl },
    });
    marker.addListener('click', () => showDetail(place));
    markers.push(marker);
  });
}

// ---- Detail view ----
function showDetail(place) {
  const overlay = document.getElementById('overlay');
  const content = document.getElementById('detailContent');
  content.innerHTML = '<div class="loading-msg">Loading details...</div>';
  overlay.classList.add('open');

  placesService.getDetails({
    placeId: place.place_id,
    fields: ['name','formatted_address','formatted_phone_number','rating','user_ratings_total',
             'price_level','opening_hours','photos','reviews','url','website','geometry']
  }, (det, status) => {
    if (status !== google.maps.places.PlacesServiceStatus.OK || !det) {
      content.innerHTML = '<div class="error-msg">Could not load details.</div>';
      return;
    }

    const dist = getDistance(userLat, userLng, det.geometry.location.lat(), det.geometry.location.lng());
    const isOpen = det.opening_hours ? det.opening_hours.isOpen() : null;
    let openBadge = '';
    if (isOpen === true) openBadge = '<span class="badge-open">Open now</span>';
    else if (isOpen === false) openBadge = '<span class="badge-closed">Closed</span>';

    // Hours
    let hoursHtml = '';
    if (det.opening_hours && det.opening_hours.weekday_text) {
      hoursHtml = '<div style="margin-top:12px;font-size:12px;color:#888;line-height:1.8">' +
        det.opening_hours.weekday_text.join('<br>') + '</div>';
    }

    // Photos
    let photosHtml = '';
    if (det.photos && det.photos.length) {
      photosHtml = '<div class="detail-photos">' +
        det.photos.slice(0, 8).map(p => `<img src="${p.getUrl({maxWidth:400})}" alt="" loading="lazy">`).join('') +
        '</div>';
    }

    // Naver Maps directions (tries app first, falls back to web)
    const destLat = det.geometry.location.lat();
    const destLng = det.geometry.location.lng();
    const destName = encodeURIComponent(det.name);
    const naverAppUrl = `nmap://route/public?dlat=${destLat}&dlng=${destLng}&dname=${destName}&appname=korea-food-finder`;
    const naverWebUrl = `https://map.naver.com/p/directions/-/${destLng},${destLat},${destName}/-/transit`;

    // Actions
    let actionsHtml = `<div class="detail-actions">
      <a class="btn-naver" href="${naverWebUrl}" target="_blank" onclick="window.location='${naverAppUrl}';return false;">Naver Maps</a>`;
    if (det.formatted_phone_number) {
      actionsHtml += `<a class="btn-call" href="tel:${det.formatted_phone_number}">Call</a>`;
    }
    actionsHtml += '</div>';

    // Reviews
    let reviewsHtml = '';
    if (det.reviews && det.reviews.length) {
      reviewsHtml = '<div class="detail-reviews"><h3>Reviews</h3>' +
        det.reviews.slice(0, 5).map(r => `
          <div class="review">
            <div class="review-author">${r.author_name} <span class="stars">${'‚òÖ'.repeat(r.rating)}</span></div>
            <div class="review-text">${r.text || ''}</div>
          </div>`).join('') +
        '</div>';
    }

    content.innerHTML = `
      <div class="detail-name">${det.name}</div>
      <div class="detail-addr">${det.formatted_address || ''}</div>
      <div class="detail-meta">
        ${starsHtml(det.rating)}
        ${det.user_ratings_total ? '<span>(' + det.user_ratings_total + ' reviews)</span>' : ''}
        ${priceHtml(det.price_level)}
        ${openBadge}
        <span>${formatDistance(dist)}</span>
      </div>
      ${hoursHtml}
      ${photosHtml}
      ${actionsHtml}
      ${reviewsHtml}
    `;
  });
}

// ---- Init map ----
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: { lat: 37.5665, lng: 126.978 }, // Seoul default
    zoom: 15,
    disableDefaultUI: true,
    zoomControl: true,
    mapTypeControl: false,
    styles: [
      { featureType: 'poi', stylers: [{ visibility: 'off' }] },
      { featureType: 'transit', stylers: [{ visibility: 'simplified' }] },
    ],
  });

  placesService = new google.maps.places.PlacesService(map);

  // Get user location
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        userLat = pos.coords.latitude;
        userLng = pos.coords.longitude;
        const loc = new google.maps.LatLng(userLat, userLng);
        map.setCenter(loc);

        userMarker = new google.maps.Marker({
          position: loc,
          map: map,
          title: 'You are here',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: '#4285f4',
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 3,
          },
        });

        searchNearby();
      },
      (err) => {
        setStatus('Location access denied. Showing Seoul center. Enable location for better results.', true);
        userLat = 37.5665;
        userLng = 126.978;
        searchNearby();
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  } else {
    setStatus('Geolocation not supported. Showing Seoul center.', true);
    userLat = 37.5665;
    userLng = 126.978;
    searchNearby();
  }
}

// Load Google Maps script
window.initMap = initMap;
</script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBTKSXtUuRGiTEaBPITI8CrO4JRlAcuz7Q&libraries=places&callback=initMap">
</script>
</body>
</html>
